<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√®o Th∆°m - Giao di·ªán Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link.active {
            background-color: #F0FDFA;
            color: #14B8A6;
            font-weight: 600;
        }
        .filter-btn.active {
            background-color: #14B8A6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .gemini-btn {
            background-color: #f0fdfa;
            color: #0d9488;
            border: 1px solid #ccfbf1;
        }
        .gemini-btn:hover {
            background-color: #ccfbf1;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #14B8A6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .profile-tab.active {
            border-bottom-color: #14B8A6;
            color: #14B8A6;
            font-weight: 600;
        }
        .lang-btn {
            background-color: #e2e8f0;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .lang-btn.active {
            background-color: #14B8A6;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Language Switcher -->
    <div class="fixed top-4 right-4 z-[60]">
        <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg">
            <button id="lang-vi" class="lang-btn">VI</button>
            <button id="lang-en" class="lang-btn">EN</button>
        </div>
    </div>

    <!-- Auth Screens Container -->
    <div id="auth-container">
        <!-- Login Screen -->
        <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
            <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-teal-600">K√®o Th∆°m</h1>
                    <p class="text-sm text-gray-500 mt-1" data-translate-key="login_prompt">ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi!</p>
                </div>
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="login_email">Email</label>
                        <input type="email" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 py-2 px-3" placeholder="email@daihoc.edu.vn">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="login_password">M·∫≠t kh·∫©u</label>
                        <input type="password" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 py-2 px-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <input id="terms-checkbox" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded">
                    <label for="terms-checkbox" class="ml-2 block text-sm text-gray-700" data-translate-key="login_terms">T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="font-medium text-teal-600 hover:underline">ƒêi·ªÅu kho·∫£n</a> v√† <a href="#" class="font-medium text-teal-600 hover:underline">Ch√≠nh s√°ch</a></label>
                </div>
                <div class="mt-6">
                    <button id="login-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" data-translate-key="login_button" disabled>
                        ƒêƒÉng nh·∫≠p
                    </button>
                </div>
                <div class="mt-6 text-center text-sm text-gray-500">
                    <p data-translate-key="login_with">ho·∫∑c ƒëƒÉng nh·∫≠p v·ªõi</p>
                    <div class="flex justify-center space-x-4 mt-2">
                        <button class="p-2 border rounded-full hover:bg-gray-100"><svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C14.03,4.73 15.1,5.5 15.71,6.09L17.9,3.9C16.21,2.56 14.2,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.2 6.42,22 12.19,22C17.6,22 21.7,18.35 21.7,12.38C21.7,11.63 21.55,11.37 21.35,11.1Z"></path></svg></button>
                        <button class="p-2 border rounded-full hover:bg-gray-100"><svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"></path></svg></button>
                    </div>
                </div>
                 <div class="mt-6 text-center text-sm">
                    <p class="text-gray-500" data-translate-key="login_signup_prompt">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="signup-link" class="font-medium text-teal-600 hover:underline" data-translate-key="login_signup_link">ƒêƒÉng k√Ω ngay</a></p>
                </div>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signup-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden">
            <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-teal-600" data-translate-key="signup_title">T·∫°o t√†i kho·∫£n</h1>
                    <p class="text-sm text-gray-500 mt-1" data-translate-key="signup_subtitle">Tham gia c·ªông ƒë·ªìng K√®o Th∆°m!</p>
                </div>
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="signup_name">H·ªç v√† T√™n</label>
                        <input type="text" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="Nguy·ªÖn VƒÉn A">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="signup_email">Email</label>
                        <input type="email" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="email@daihoc.edu.vn">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="signup_password">M·∫≠t kh·∫©u</label>
                        <input type="password" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div class="mt-6">
                    <button id="signup-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700" data-translate-key="signup_button">
                        ƒêƒÉng k√Ω
                    </button>
                </div>
                <div class="mt-6 text-center text-sm">
                    <p class="text-gray-500" data-translate-key="signup_login_prompt">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="back-to-login-link" class="font-medium text-teal-600 hover:underline" data-translate-key="signup_login_link">ƒêƒÉng nh·∫≠p</a></p>
                </div>
            </div>
        </div>

        <!-- Verification Screen -->
        <div id="verification-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden">
            <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg text-center">
                <h1 class="text-2xl font-bold text-teal-600" data-translate-key="verify_title">X√°c minh danh t√≠nh</h1>
                <p class="text-sm text-gray-500 mt-2 mb-6" data-translate-key="verify_subtitle">ƒê·ªÉ ƒë·∫£m b·∫£o an to√†n, vui l√≤ng t·∫£i l√™n ·∫£nh m·∫∑t tr∆∞·ªõc CCCD c·ªßa b·∫°n.</p>
                <div class="mt-6">
                    <label for="cccd-upload" class="cursor-pointer bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-10 flex flex-col items-center justify-center hover:bg-gray-200">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <p id="upload-text" class="mt-2 text-sm text-gray-600" data-translate-key="verify_front">Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n</p>
                    </label>
                    <input id="cccd-upload" type="file" class="hidden" accept="image/*">
                </div>
                <div class="mt-6">
                    <button id="submit-verification-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-gray-300 disabled:cursor-not-allowed" data-translate-key="verify_button" disabled>
                        Ho√†n t·∫•t & B·∫Øt ƒë·∫ßu
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Main App Wrapper -->
    <div id="main-app" class="flex h-screen overflow-hidden hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-teal-600">K√®o Th∆°m</h1>
                <p class="text-xs text-gray-500" data-translate-key="tagline">K·∫øt n·ªëi t·ª©c th·ªùi, G·∫Øn k·∫øt c·ªông ƒë·ªìng.</p>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="sidebar-link flex items-center px-4 py-2 text-gray-700 rounded-lg active">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span data-translate-key="nav_home">Trang ch·ªß</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span data-translate-key="nav_my_keos">K√®o c·ªßa t√¥i</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">
                     <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span data-translate-key="nav_notifications">Th√¥ng b√°o</span>
                </a>
            </nav>
            <div class="px-6 py-4 border-t border-gray-200">
                <button id="create-keo-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span data-translate-key="create_keo_button">T·∫°o K√®o M·ªõi</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <div class="relative w-full max-w-md">
                    <input type="text" class="w-full bg-gray-100 border border-gray-200 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-teal-500" data-translate-key="search_placeholder" placeholder="T√¨m ki·∫øm k√®o...">
                    <svg class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="profile-btn" class="flex items-center space-x-4 cursor-pointer">
                    <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/A7F3D0/134E4A?text=MA" alt="User avatar">
                    <span class="font-semibold">Minh Anh</span> <!-- Placeholder, will be updated -->
                </div>
            </header>
            
            <div class="flex-1 flex overflow-hidden">
                <!-- K√®o Feed -->
                <section class="flex-1 overflow-y-auto p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-4" data-translate-key="feed_title">K√®o N·ªïi B·∫≠t Quanh ƒê√¢y</h2>
                        <div id="filters" class="flex flex-wrap gap-2">
                            <button class="filter-btn active px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 hover:bg-gray-300 transition-colors" data-filter="all" data-translate-key="filter_all">T·∫•t c·∫£</button>
                            <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 hover:bg-gray-300 transition-colors" data-filter="ƒÇn u·ªëng" data-translate-key="filter_eating">üçî ƒÇn u·ªëng</button>
                            <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 hover:bg-gray-300 transition-colors" data-filter="Th·ªÉ thao" data-translate-key="filter_sports">‚öΩÔ∏è Th·ªÉ thao</button>
                            <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 hover:bg-gray-300 transition-colors" data-filter="H·ªçc t·∫≠p" data-translate-key="filter_study">üìö H·ªçc t·∫≠p</button>
                            <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 hover:bg-gray-300 transition-colors" data-filter="Gi·∫£i tr√≠" data-translate-key="filter_fun">üé¨ Gi·∫£i tr√≠</button>
                        </div>
                    </div>
                    <div id="keo-feed" class="space-y-4">
                        <!-- K√®o cards dynamically generated -->
                    </div>
                </section>
                
                <!-- Map & Details -->
                <aside class="w-1/3 bg-white border-l border-gray-200 p-6 flex-col hidden lg:flex">
                     <h3 class="text-xl font-bold mb-4" data-translate-key="map_title">B·∫£n ƒë·ªì K√®o</h3>
                     <div class="relative w-full h-64 bg-gray-100 rounded-lg overflow-hidden mb-6 border">
                        <div id="map"></div>
                     </div>
                     <div id="keo-details" class="flex-1 overflow-y-auto">
                        <div class="text-center text-gray-500 pt-10">
                            <p class="text-lg font-semibold" data-translate-key="details_prompt_title">Ch·ªçn m·ªôt k√®o ƒë·ªÉ xem chi ti·∫øt</p>
                            <p class="text-sm" data-translate-key="details_prompt_subtitle">Th√¥ng tin v·ªÅ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian v√† ng∆∞·ªùi tham gia s·∫Ω hi·ªán ·ªü ƒë√¢y.</p>
                        </div>
                     </div>
                </aside>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- Create Keo Modal -->
        <div id="create-keo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-40">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-6" data-translate-key="modal_create_title">T·∫°o K√®o M·ªõi</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="modal_create_content">N·ªôi dung k√®o</label>
                        <div class="flex items-center space-x-2">
                            <input id="keo-title-input" type="text" class="flex-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500" placeholder="VD: T√¨m ng∆∞·ªùi ƒÉn tr∆∞a b√∫n ƒë·∫≠u...">
                            <button id="gemini-title-btn" class="gemini-btn font-semibold py-2 px-3 rounded-md flex items-center space-x-2 text-sm">
                                <span data-translate-key="modal_create_suggest">‚ú® G·ª£i √Ω</span>
                                <div id="title-loader" class="loader hidden"></div>
                            </button>
                        </div>
                        <div id="title-suggestions" class="mt-2 space-y-1"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="modal_create_category">Lo·∫°i k√®o</label>
                        <select id="keo-category-input" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                            <option data-translate-key="category_eating">ƒÇn u·ªëng</option> 
                            <option data-translate-key="category_sports">Th·ªÉ thao</option> 
                            <option data-translate-key="category_study">H·ªçc t·∫≠p</option> 
                            <option data-translate-key="category_fun">Gi·∫£i tr√≠</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="modal_create_location">ƒê·ªãa ƒëi·ªÉm</label>
                        <input id="keo-location-input" type="text" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500" placeholder="VD: Qu√°n C√¢y B√†ng, Ch√πa L√°ng">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="modal_create_max_participants">S·ªë ng∆∞·ªùi t·ªëi ƒëa (g·ªìm b·∫°n)</label>
                        <input id="keo-max-input" type="number" min="2" value="5" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button class="close-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300" data-translate-key="modal_cancel">H·ªßy</button>
                    <button id="publish-keo-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700" data-translate-key="modal_create_publish">ƒêƒÉng K√®o</button>
                </div>
            </div>
        </div>
        <!-- Profile Modal -->
        <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-40">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
                 <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="flex items-center space-x-6 mb-6">
                    <img id="profile-modal-avatar" class="w-24 h-24 rounded-full border-4 border-teal-500" src="https://placehold.co/100x100/A7F3D0/134E4A?text=MA" alt="User avatar">
                    <div>
                        <h2 id="profile-modal-name" class="text-3xl font-bold">Minh Anh</h2>
                        <p id="profile-modal-university" class="text-gray-500" data-translate-key="profile_university">Sinh vi√™n - ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi</p>
                        <div id="profile-modal-tags" class="flex flex-wrap gap-2 mt-3">
                            <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">#Badminton</span>
                            <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">#CoffeeLover</span>
                            <span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">#Photography</span>
                        </div>
                    </div>
                </div>
                
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button class="profile-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="created" data-translate-key="profile_tab_created">K√®o ƒë√£ t·∫°o</button>
                        <button class="profile-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="joined" data-translate-key="profile_tab_joined">K√®o ƒë√£ tham gia</button>
                    </nav>
                </div>

                <div id="tab-content-created" class="py-4 max-h-60 overflow-y-auto">
                   <p class="text-gray-500 text-center" data-translate-key="profile_no_created">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>
                   <!-- Created Keos will be listed here -->
                </div>
                 <div id="tab-content-joined" class="py-4 max-h-60 overflow-y-auto hidden">
                   <p class="text-gray-500 text-center" data-translate-key="profile_no_joined">B·∫°n ch∆∞a tham gia k√®o n√†o.</p>
                   <!-- Joined Keos will be listed here -->
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="logout-btn" class="text-sm text-red-600 font-semibold hover:underline" data-translate-key="profile_logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Data ---
    let DUMMY_KEOS = [
      { id: '1', category: 'ƒÇn u·ªëng', title: 'T√¨m ng∆∞·ªùi ƒÉn tr∆∞a b√∫n ƒë·∫≠u C√¢y B√†ng', location: '1km - C√¢y B√†ng, Ch√πa L√°ng', time: 'C√≤n 30 ph√∫t', participants: ['An', 'Minh', 'Hoa'], maxParticipants: 4, avatar: 'üçî', lat: 21.025, lng: 105.800, creator: 'An'},
      { id: '2', category: 'Th·ªÉ thao', title: 'L·∫≠p team ƒë√° b√≥ng s√¢n C·∫ßu Gi·∫•y', location: '2.5km - S√¢n b√≥ng C·∫ßu Gi·∫•y', time: 'B·∫Øt ƒë·∫ßu l√∫c 17:00', participants: ['H√πng', 'S∆°n', 'ƒê·ª©c', 'Ki√™n', 'Long'], maxParticipants: 7, avatar: '‚öΩÔ∏è', lat: 21.030, lng: 105.790, creator: 'H√πng'},
      { id: '3', category: 'H·ªçc t·∫≠p', title: 'T√¨m b·∫°n h·ªçc nh√≥m m√¥n Tri·∫øt', location: '500m - Th∆∞ vi·ªán T·∫° Quang B·ª≠u', time: 'B√¢y gi·ªù', participants: ['Linh'], maxParticipants: 3, avatar: 'üìö', lat: 21.006, lng: 105.843, creator: 'Linh'},
      { id: '4', category: 'Gi·∫£i tr√≠', title: 'T√¨m 2 ng∆∞·ªùi xem phim Oppenheimer su·∫•t 8h', location: '3km - CGV Vincom NCT', time: 'C√≤n 2 gi·ªù', participants: ['Mai', 'T√∫'], maxParticipants: 4, avatar: 'üé¨', lat: 21.018, lng: 105.810, creator: 'Mai'},
      { id: '5', category: 'ƒÇn u·ªëng', title: 'ƒêi u·ªëng tr√† chanh Nh√† Th·ªù', location: '4km - Ph·ªë Nh√† Th·ªù', time: 'T·ªëi nay 8h', participants: ['Quang', 'Trang'], maxParticipants: 5, avatar: 'üçã', lat: 21.028, lng: 105.850, creator: 'Quang'},
    ];
    
    // --- User State ---
    let currentUser = { name: 'Minh Anh', university: 'ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi', avatarInitial: 'MA' }; // Default user
    let userCreatedKeos = [];
    let userJoinedKeos = [];

    // --- Translations Object ---
    const translations = {
        vi: {
            // Login & Auth
            login_prompt: 'ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi!',
            login_email: 'Email',
            login_password: 'M·∫≠t kh·∫©u',
            login_terms: 'T√¥i ƒë·ªìng √Ω v·ªõi ',
            login_terms_link: 'ƒêi·ªÅu kho·∫£n',
            login_policy_link: 'Ch√≠nh s√°ch',
            login_button: 'ƒêƒÉng nh·∫≠p',
            login_with: 'ho·∫∑c ƒëƒÉng nh·∫≠p v·ªõi',
            login_signup_prompt: 'Ch∆∞a c√≥ t√†i kho·∫£n? ',
            login_signup_link: 'ƒêƒÉng k√Ω ngay',
            signup_title: 'T·∫°o t√†i kho·∫£n',
            signup_subtitle: 'Tham gia c·ªông ƒë·ªìng K√®o Th∆°m!',
            signup_name: 'H·ªç v√† T√™n',
            signup_email: 'Email',
            signup_password: 'M·∫≠t kh·∫©u',
            signup_button: 'ƒêƒÉng k√Ω',
            signup_login_prompt: 'ƒê√£ c√≥ t√†i kho·∫£n? ',
            signup_login_link: 'ƒêƒÉng nh·∫≠p',
            verify_title: 'X√°c minh danh t√≠nh',
            verify_subtitle: 'ƒê·ªÉ ƒë·∫£m b·∫£o an to√†n, vui l√≤ng t·∫£i l√™n ·∫£nh m·∫∑t tr∆∞·ªõc CCCD c·ªßa b·∫°n.',
            verify_front: 'Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n',
            verify_button: 'Ho√†n t·∫•t & B·∫Øt ƒë·∫ßu',
            upload_status_uploaded: 'ƒê√£ t·∫£i l√™n ‚úì',

            // Main App UI
            tagline: 'K·∫øt n·ªëi t·ª©c th·ªùi, G·∫Øn k·∫øt c·ªông ƒë·ªìng.',
            nav_home: 'Trang ch·ªß',
            nav_my_keos: 'K√®o c·ªßa t√¥i',
            nav_notifications: 'Th√¥ng b√°o',
            create_keo_button: 'T·∫°o K√®o M·ªõi',
            search_placeholder: 'T√¨m ki·∫øm k√®o...',
            feed_title: 'K√®o N·ªïi B·∫≠t Quanh ƒê√¢y',
            filter_all: 'T·∫•t c·∫£',
            filter_eating: 'üçî ƒÇn u·ªëng',
            filter_sports: '‚öΩÔ∏è Th·ªÉ thao',
            filter_study: 'üìö H·ªçc t·∫≠p',
            filter_fun: 'üé¨ Gi·∫£i tr√≠',
            map_title: 'B·∫£n ƒë·ªì K√®o',
            details_prompt_title: 'Ch·ªçn m·ªôt k√®o ƒë·ªÉ xem chi ti·∫øt',
            details_prompt_subtitle: 'Th√¥ng tin v·ªÅ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian v√† ng∆∞·ªùi tham gia s·∫Ω hi·ªán ·ªü ƒë√¢y.',
            no_keo_found: 'Kh√¥ng c√≥ k√®o n√†o ph√π h·ª£p.',
            participants_count_suffix: 'ng∆∞·ªùi',

            // Create Keo Modal
            modal_create_title: 'T·∫°o K√®o M·ªõi',
            modal_create_content: 'N·ªôi dung k√®o',
            modal_create_suggest: '‚ú® G·ª£i √Ω',
            modal_create_category: 'Lo·∫°i k√®o',
            category_eating: 'ƒÇn u·ªëng',
            category_sports: 'Th·ªÉ thao',
            category_study: 'H·ªçc t·∫≠p',
            category_fun: 'Gi·∫£i tr√≠',
            modal_create_location: 'ƒê·ªãa ƒëi·ªÉm',
            modal_create_max_participants: 'S·ªë ng∆∞·ªùi t·ªëi ƒëa (g·ªìm b·∫°n)',
            modal_cancel: 'H·ªßy',
            modal_create_publish: 'ƒêƒÉng K√®o',
            alert_fill_fields: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung v√† ƒë·ªãa ƒëi·ªÉm.',

            // Profile Modal
            profile_university: 'Sinh vi√™n - ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi',
            profile_tab_created: 'K√®o ƒë√£ t·∫°o',
            profile_tab_joined: 'K√®o ƒë√£ tham gia',
            profile_no_created: 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.',
            profile_no_joined: 'B·∫°n ch∆∞a tham gia k√®o n√†o.',
            profile_logout: 'ƒêƒÉng xu·∫•t',

            // Keo Details
            details_participants_title: 'Nh·ªØng ng∆∞·ªùi s·∫Ω tham gia',
            details_join_button: 'Tham gia K√®o n√†y',
            details_leave_button: 'R·ªùi kh·ªèi K√®o',
            details_full: 'K√®o ƒë√£ ƒë·ªß ng∆∞·ªùi',
            details_icebreaker_button: '‚ú® G·ª£i √Ω c√¢u ch√†o h·ªèi (AI)',
            details_icebreaker_title: '‚ú® Th·ª≠ v√†i c√¢u h·ªèi ph√° bƒÉng (AI):',

            // Gemini specific
            gemini_error: 'ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i.',
            gemini_prompt_title: 'Vui l√≤ng nh·∫≠p lo·∫°i k√®o ho·∫∑c ƒë·ªãa ƒëi·ªÉm ƒë·ªÉ AI g·ª£i √Ω.',
        },
        en: {
            // Login & Auth
            login_prompt: 'Login to start connecting!',
            login_email: 'Email',
            login_password: 'Password',
            login_terms: 'I agree to the ',
            login_terms_link: 'Terms',
            login_policy_link: 'Policy',
            login_button: 'Login',
            login_with: 'or log in with',
            login_signup_prompt: "Don't have an account? ",
            login_signup_link: 'Sign up now',
            signup_title: 'Create Account',
            signup_subtitle: 'Join the K√®o Th∆°m community!',
            signup_name: 'Full Name',
            signup_email: 'Email',
            signup_password: 'Password',
            signup_button: 'Sign Up',
            signup_login_prompt: 'Already have an account? ',
            signup_login_link: 'Log in',
            verify_title: 'Identity Verification',
            verify_subtitle: 'For community safety, please upload the front of your National ID.',
            verify_front: 'Click to upload photo',
            verify_button: 'Complete & Get Started',
            upload_status_uploaded: 'Uploaded ‚úì',

            // Main App UI
            tagline: 'Spontaneous Connections, Stronger Communities.',
            nav_home: 'Home',
            nav_my_keos: 'My Keos',
            nav_notifications: 'Notifications',
            create_keo_button: 'Create New Keo',
            search_placeholder: 'Search for keos...',
            feed_title: 'Featured Keos Nearby',
            filter_all: 'All',
            filter_eating: 'üçî Eating',
            filter_sports: '‚öΩÔ∏è Sports',
            filter_study: 'üìö Study',
            filter_fun: 'üé¨ Fun',
            map_title: 'Keo Map',
            details_prompt_title: 'Select a keo to see details',
            details_prompt_subtitle: 'Information about location, time, and participants will appear here.',
            no_keo_found: 'No matching keos found.',
            participants_count_suffix: 'people',

             // Create Keo Modal
            modal_create_title: 'Create New Keo',
            modal_create_content: 'Keo content',
            modal_create_suggest: '‚ú® Suggest',
            modal_create_category: 'Keo type',
            category_eating: 'Eating',
            category_sports: 'Sports',
            category_study: 'Study',
            category_fun: 'Fun',
            modal_create_location: 'Location',
            modal_create_max_participants: 'Max participants (incl. you)',
            modal_cancel: 'Cancel',
            modal_create_publish: 'Post Keo',
            alert_fill_fields: 'Please fill in the content and location.',

            // Profile Modal
            profile_university: 'Student - Vietnam National University, Hanoi',
            profile_tab_created: 'Created Keos',
            profile_tab_joined: 'Joined Keos',
            profile_no_created: 'No activities yet.',
            profile_no_joined: "You haven't joined any keos yet.",
            profile_logout: 'Logout',

            // Keo Details
            details_participants_title: 'Who will join',
            details_join_button: 'Join this Keo',
            details_leave_button: 'Leave Keo',
            details_full: 'Keo is full',
            details_icebreaker_button: '‚ú® Suggest Icebreakers (AI)',
            details_icebreaker_title: '‚ú® Try some icebreakers (AI):',

            // Gemini specific
            gemini_error: 'An error occurred, please try again.',
            gemini_prompt_title: 'Please enter a keo type or location for AI suggestions.',
        }
    };
    
    // --- DOM Elements ---
    const authContainer = document.getElementById('auth-container');
    const loginScreen = document.getElementById('login-screen');
    const signupScreen = document.getElementById('signup-screen');
    const verificationScreen = document.getElementById('verification-screen');
    const mainApp = document.getElementById('main-app');
    const loginBtn = document.getElementById('login-btn');
    const signupLink = document.getElementById('signup-link');
    const backToLoginLink = document.getElementById('back-to-login-link');
    const signupBtn = document.getElementById('signup-btn');
    const submitVerificationBtn = document.getElementById('submit-verification-btn');
    const cccdUploadInput = document.getElementById('cccd-upload');
    const uploadText = document.getElementById('upload-text');
    const termsCheckbox = document.getElementById('terms-checkbox');
    const keoFeed = document.getElementById('keo-feed');
    const filtersContainer = document.getElementById('filters');
    const keoDetailsContainer = document.getElementById('keo-details');
    const profileBtn = document.getElementById('profile-btn');
    const profileModal = document.getElementById('profile-modal');
    const logoutBtn = document.getElementById('logout-btn');
    const profileName = document.getElementById('profile-modal-name');
    const profileUniversity = document.getElementById('profile-modal-university');
    const profileAvatar = document.getElementById('profile-modal-avatar');
    const profileAvatarText = document.querySelector('#profile-btn img');
    const profileHeaderText = document.querySelector('#profile-btn span');
    const createdKeosTab = document.getElementById('tab-content-created');
    const joinedKeosTab = document.getElementById('tab-content-joined');
    
    const createKeoBtn = document.getElementById('create-keo-btn');
    const createKeoModal = document.getElementById('create-keo-modal');
    
    const geminiTitleBtn = document.getElementById('gemini-title-btn');
    const titleLoader = document.getElementById('title-loader');
    const titleSuggestionsContainer = document.getElementById('title-suggestions');
    const keoTitleInput = document.getElementById('keo-title-input');
    const keoCategoryInput = document.getElementById('keo-category-input');
    const keoLocationInput = document.getElementById('keo-location-input');
    const keoMaxInput = document.getElementById('keo-max-input');
    const publishKeoBtn = document.getElementById('publish-keo-btn');
    
    let map;
    let markers = [];
    let activeMarker = null;

    let currentLang = 'vi';

    // --- Language Function ---
    function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (translations[lang] && translations[lang][key]) {
                // Handle complex innerHTML for terms link
                 if (key === 'login_terms') {
                     el.innerHTML = `${translations[lang][key]}<a href="#" class="font-medium text-teal-600 hover:underline">${translations[lang]['login_terms_link']}</a> ${lang === 'vi' ? 'v√†' : 'and'} <a href="#" class="font-medium text-teal-600 hover:underline">${translations[lang]['login_policy_link']}</a>`;
                 } else {
                     el.textContent = translations[lang][key];
                 }
            }
        });
        
        // Re-attach listeners for dynamically created links in login/signup prompts
        const signupPrompt = document.querySelector('[data-translate-key="login_signup_prompt"]');
        if (signupPrompt) {
            signupPrompt.innerHTML = `${translations[lang]['login_signup_prompt']}<a href="#" id="signup-link-dynamic" class="font-medium text-teal-600 hover:underline">${translations[lang]['login_signup_link']}</a>`;
            document.getElementById('signup-link-dynamic').addEventListener('click', showSignupScreen);
        }
        const loginPrompt = document.querySelector('[data-translate-key="signup_login_prompt"]');
         if (loginPrompt) {
            loginPrompt.innerHTML = `${translations[lang]['signup_login_prompt']}<a href="#" id="back-to-login-link-dynamic" class="font-medium text-teal-600 hover:underline">${translations[lang]['signup_login_link']}</a>`;
            document.getElementById('back-to-login-link-dynamic').addEventListener('click', showLoginScreen);
        }

        // Update placeholder texts if needed
        const searchInput = document.querySelector('input[data-translate-key="search_placeholder"]');
        if(searchInput) searchInput.placeholder = translations[lang].search_placeholder;
        
        // Update language buttons state
        document.getElementById('lang-vi').classList.toggle('active', lang === 'vi');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');

        // Update university name in profile modal based on language
        profileUniversity.textContent = lang === 'vi' ? 'Sinh vi√™n - ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi' : 'Student - Vietnam National University, Hanoi';


        // Re-render dynamic content like Keo feed and details
        const currentFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
        renderKeos(currentFilter); // This function needs to handle translations internally
        
        // Reset details pane
        keoDetailsContainer.innerHTML = `<div class="text-center text-gray-500 pt-10"><p class="text-lg font-semibold">${translations[lang].details_prompt_title}</p><p class="text-sm">${translations[lang].details_prompt_subtitle}</p></div>`;
        
        // Update profile tab content placeholders
        if (userCreatedKeos.length === 0) createdKeosTab.querySelector('p').textContent = translations[lang].profile_no_created;
        if (userJoinedKeos.length === 0) joinedKeosTab.querySelector('p').textContent = translations[lang].profile_no_joined;
    }


    // --- Map Functions ---
    function initMap() {
        const hanoi = { lat: 21.0278, lng: 105.8342 };
        map = new google.maps.Map(document.getElementById("map"), {
            center: hanoi,
            zoom: 13,
            disableDefaultUI: true,
            styles: [{"featureType": "poi","stylers": [{ "visibility": "off" }]},{"featureType": "road","elementType": "labels.icon","stylers": [{ "visibility": "off" }]},{"featureType": "transit","stylers": [{ "visibility": "off" }]}]
        });
        renderKeos('all'); // Initial render populates map
    }

    const highlightMarker = (marker) => {
        if (!marker) return;
        if (activeMarker) activeMarker.setAnimation(null);
        marker.setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(() => marker.setAnimation(null), 1400); // Bounce for 2 cycles
        map.panTo(marker.getPosition());
        map.setZoom(15);
        activeMarker = marker;
    };

     const clearMarkers = () => {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        activeMarker = null;
    }

    const addMarker = (keo) => {
        if (!map || !keo.lat || !keo.lng) return;
        const marker = new google.maps.Marker({
            position: { lat: keo.lat, lng: keo.lng },
            map: map,
            title: keo.title,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#14B8A6', fillOpacity: 1, strokeWeight: 2, strokeColor: 'white' }
        });
        marker.keoId = keo.id;
        marker.addListener("click", () => {
             renderKeoDetails(keo); // Show details when marker is clicked
        });
        markers.push(marker);
        return marker; // Return the marker object
    }

    // --- Gemini API Call Function ---
    async function callGemini(prompt, retries = 3, delay = 1000) {
        const apiKey = ""; // Keep empty
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (candidate?.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else { throw new Error("Invalid response structure from Gemini API"); }
        } catch (error) {
            console.error("Gemini API call failed:", error);
            if (retries > 0) {
                await new Promise(res => setTimeout(res, delay));
                return callGemini(prompt, retries - 1, delay * 2);
            }
            return translations[currentLang].gemini_error;
        }
    }
    
    // --- Gemini Feature 1: Title Suggestion ---
    geminiTitleBtn.addEventListener('click', async () => {
        const category = keoCategoryInput.value;
        const location = keoLocationInput.value;
        if (!category && !location) {
            alert(translations[currentLang].gemini_prompt_title);
            return;
        }
        titleLoader.classList.remove('hidden');
        geminiTitleBtn.disabled = true;
        titleSuggestionsContainer.innerHTML = '';
        const prompt = currentLang === 'vi' ? `G·ª£i √Ω 3 t√™n "k√®o" th·∫≠t h·∫•p d·∫´n, ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát cho sinh vi√™n. VƒÉn phong tr·∫ª trung. Lo·∫°i k√®o: ${category}. ƒê·ªãa ƒëi·ªÉm: ${location}. Ch·ªâ tr·∫£ v·ªÅ 3 g·ª£i √Ω, m·ªói g·ª£i √Ω tr√™n m·ªôt d√≤ng, kh√¥ng ƒë√°nh s·ªë.` : `Suggest 3 catchy, short "event" names in English for university students. Keep a fun, youthful tone. Event type: ${category}. Location: ${location}. Return only 3 suggestions, each on a new line, without any numbering.`;
        const response = await callGemini(prompt);
        const suggestions = response.split('\n').filter(s => s.trim() !== '');
        suggestions.forEach(suggestion => {
            const btn = document.createElement('button');
            btn.textContent = suggestion;
            btn.className = 'w-full text-left p-2 bg-gray-100 rounded-md hover:bg-gray-200 text-sm';
            btn.onclick = () => { keoTitleInput.value = suggestion; titleSuggestionsContainer.innerHTML = ''; };
            titleSuggestionsContainer.appendChild(btn);
        });
        titleLoader.classList.add('hidden');
        geminiTitleBtn.disabled = false;
    });

    // --- Gemini Feature 2: Icebreakers ---
    const generateIcebreakers = async (keoTitle) => {
        const icebreakerContainer = document.getElementById('icebreaker-container');
        if (!icebreakerContainer) return; // Check if element exists
        icebreakerContainer.innerHTML = `<div class="flex items-center justify-center p-4"><div class="loader"></div></div>`;
        const prompt = currentLang === 'vi' ? `G·ª£i √Ω 3 c√¢u h·ªèi "ph√° bƒÉng" t·ª± nhi√™n, th√∫ v·ªã ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán cho nh√≥m sinh vi√™n l·∫ßn ƒë·∫ßu g·∫∑p m·∫∑t trong ho·∫°t ƒë·ªông: "${keoTitle}". Gi·ªØ c√¢u h·ªèi ng·∫Øn g·ªçn. Ch·ªâ tr·∫£ v·ªÅ 3 c√¢u h·ªèi, m·ªói c√¢u tr√™n m·ªôt d√≤ng, kh√¥ng ƒë√°nh s·ªë.` : `Suggest 3 natural, fun "icebreaker" questions to start a conversation for a group of university students meeting for the first time at this event: "${keoTitle}". Keep the questions short and open-ended. Return only 3 questions, each on a new line, without any numbering.`;
        const response = await callGemini(prompt);
        const icebreakers = response.split('\n').filter(s => s.trim() !== '');
        icebreakerContainer.innerHTML = `<h4 class="font-bold mb-2">${translations[currentLang].details_icebreaker_title}</h4><ul class="list-disc list-inside space-y-2 text-sm text-gray-600">${icebreakers.map(q => `<li>${q}</li>`).join('')}</ul>`;
    };

    // --- Render Keo Details ---
    const renderKeoDetails = (keo) => {
        if (!keo) { // Handle case where keo might be undefined
             keoDetailsContainer.innerHTML = `<div class="text-center text-gray-500 pt-10"><p class="text-lg font-semibold">${translations[currentLang].details_prompt_title}</p><p class="text-sm">${translations[currentLang].details_prompt_subtitle}</p></div>`;
             return;
        }
        const participantAvatars = keo.participants.map(p => `<div class="w-10 h-10 rounded-full bg-teal-100 text-teal-700 font-bold flex items-center justify-center border-2 border-white" title="${p}">${p.charAt(0)}</div>`).join('');
        const isParticipant = keo.participants.includes(currentUser.name);
        const isFull = keo.participants.length >= keo.maxParticipants;

        let joinButtonHTML = '';
        if (isParticipant) {
            joinButtonHTML = `<button id="leave-keo-btn" data-keo-id="${keo.id}" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">${translations[currentLang].details_leave_button}</button>`;
        } else if (isFull) {
            joinButtonHTML = `<button class="w-full bg-gray-300 text-gray-500 font-bold py-3 px-4 rounded-lg cursor-not-allowed">${translations[currentLang].details_full}</button>`;
        } else {
             joinButtonHTML = `<button id="join-keo-btn" data-keo-id="${keo.id}" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors">${translations[currentLang].details_join_button}</button>`;
        }

        keoDetailsContainer.innerHTML = `
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-sm font-bold text-orange-600">${keo.category}</p>
                <h2 class="text-2xl font-bold mt-1">${keo.title}</h2>
            </div>
            <div class="mt-4 space-y-3">
                <div class="flex items-center text-gray-600">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="truncate" title="${keo.location}">${keo.location}</span>
                </div>
                <div class="flex items-center text-gray-600">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>${keo.time}</span>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="font-bold mb-3">${translations[currentLang].details_participants_title} (${keo.participants.length}/${keo.maxParticipants})</h4>
                <div class="flex -space-x-2 flex-wrap">
                    ${participantAvatars}
                </div>
            </div>
            <div id="icebreaker-section" class="mt-6 space-y-2">
                 <button id="gemini-icebreaker-btn" class="w-full gemini-btn font-semibold py-2 px-3 rounded-md flex items-center justify-center space-x-2 text-sm">
                    <span>${translations[currentLang].details_icebreaker_button}</span>
                 </button>
                 <div id="icebreaker-container" class="p-4 bg-gray-50 rounded-lg hidden"></div>
            </div>
            <div class="mt-4">
                ${joinButtonHTML}
            </div>
        `;
        
        // Add event listeners for dynamic buttons
        const icebreakerBtn = document.getElementById('gemini-icebreaker-btn');
        if(icebreakerBtn) {
            icebreakerBtn.addEventListener('click', () => { 
                document.getElementById('icebreaker-container')?.classList.remove('hidden');
                generateIcebreakers(keo.title); 
            });
        }
        
        const joinBtn = document.getElementById('join-keo-btn');
        if(joinBtn) {
            joinBtn.addEventListener('click', () => handleJoinKeo(keo.id));
        }
        
        const leaveBtn = document.getElementById('leave-keo-btn');
        if(leaveBtn) {
            leaveBtn.addEventListener('click', () => handleLeaveKeo(keo.id));
        }

        // Highlight marker on map
        const targetMarker = markers.find(m => m.keoId === keo.id);
        if (targetMarker) highlightMarker(targetMarker);
    }

    // --- Join/Leave Keo Logic ---
    function handleJoinKeo(keoId) {
        const keoIndex = DUMMY_KEOS.findIndex(k => k.id === keoId);
        if (keoIndex !== -1 && !DUMMY_KEOS[keoIndex].participants.includes(currentUser.name) && DUMMY_KEOS[keoIndex].participants.length < DUMMY_KEOS[keoIndex].maxParticipants) {
            DUMMY_KEOS[keoIndex].participants.push(currentUser.name);
            userJoinedKeos.push(DUMMY_KEOS[keoIndex]); // Add to joined list
            renderKeoDetails(DUMMY_KEOS[keoIndex]); // Re-render details
            renderKeos(document.querySelector('.filter-btn.active').dataset.filter); // Re-render feed to update count
        }
    }
    
    function handleLeaveKeo(keoId) {
        const keoIndex = DUMMY_KEOS.findIndex(k => k.id === keoId);
        if (keoIndex !== -1) {
            DUMMY_KEOS[keoIndex].participants = DUMMY_KEOS[keoIndex].participants.filter(p => p !== currentUser.name);
             userJoinedKeos = userJoinedKeos.filter(k => k.id !== keoId); // Remove from joined list
            renderKeoDetails(DUMMY_KEOS[keoIndex]); // Re-render details
            renderKeos(document.querySelector('.filter-btn.active').dataset.filter); // Re-render feed to update count
        }
    }
    
    // --- Render Keo Feed ---
    const renderKeos = (filter = 'all') => {
        keoFeed.innerHTML = '';
        clearMarkers(); // Clear existing markers before adding new ones
        const filteredKeos = filter === 'all' 
            ? DUMMY_KEOS 
            : DUMMY_KEOS.filter(keo => keo.category === translations['vi'][`category_${filter.toLowerCase()}`] || keo.category === translations['en'][`category_${filter.toLowerCase()}`] || keo.category === filter ); // Handle category filter with translation

        if (filteredKeos.length === 0) {
            keoFeed.innerHTML = `<p class="text-center text-gray-500">${translations[currentLang].no_keo_found}</p>`;
            return;
        }

        filteredKeos.forEach(keo => {
            const keoCard = document.createElement('div');
            keoCard.className = 'bg-white p-4 rounded-lg border border-gray-200 cursor-pointer hover:border-teal-500 hover:shadow-md transition-all';
            keoCard.onclick = () => renderKeoDetails(keo); 

            const participantAvatars = keo.participants.slice(0, 3).map(p => 
                `<div class="w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-bold flex items-center justify-center border-2 border-white" title="${p}">${p.charAt(0)}</div>`
            ).join('');
            
            const moreParticipants = keo.participants.length > 3 
                ? `<div class="w-8 h-8 rounded-full bg-gray-300 text-gray-700 text-sm font-bold flex items-center justify-center border-2 border-white">+${keo.participants.length - 3}</div>` 
                : '';

            keoCard.innerHTML = `
                <div class="flex items-start">
                    <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mr-4 text-2xl flex-shrink-0">${keo.avatar}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-orange-600 truncate">${keo.category}</p>
                        <h3 class="font-bold text-lg leading-tight truncate" title="${keo.title}">${keo.title}</h3>
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${keo.location}">${keo.location}</p>
                    </div>
                    <div class="text-right ml-2 flex-shrink-0">
                        <p class="text-sm font-semibold text-teal-600 whitespace-nowrap">${keo.time}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                    <div class="flex -space-x-2 flex-shrink-0">
                        ${participantAvatars}
                        ${moreParticipants}
                    </div>
                    <span class="text-sm font-bold ml-2 whitespace-nowrap">${keo.participants.length}/${keo.maxParticipants} ${translations[currentLang].participants_count_suffix}</span>
                </div>
            `;
            keoFeed.appendChild(keoCard);

            // Add marker to map for each keo
            addMarker(keo);
        });
    };

    // --- Publish Keo Functionality ---
    publishKeoBtn.addEventListener('click', () => {
        const title = keoTitleInput.value;
        const category = keoCategoryInput.value;
        const location = keoLocationInput.value;
        const maxP = parseInt(keoMaxInput.value) || 2; // Default to 2 if invalid

        if (!title.trim() || !location.trim()) {
            alert(translations[currentLang].alert_fill_fields);
            return;
        }

        const categoryMap = { 'ƒÇn u·ªëng': 'üçî', 'Th·ªÉ thao': '‚öΩÔ∏è', 'H·ªçc t·∫≠p': 'üìö', 'Gi·∫£i tr√≠': 'üé¨', 'Eating': 'üçî', 'Sports': '‚öΩÔ∏è', 'Study': 'üìö', 'Fun': 'üé¨' };

        const newKeo = {
            id: 'keo-' + Date.now(),
            category: category,
            title: title,
            location: location,
            time: currentLang === 'vi' ? 'V·ª´a xong' : 'Just now',
            participants: [currentUser.name], // Creator automatically joins
            maxParticipants: maxP,
            avatar: categoryMap[category] || 'üéâ',
            lat: 21.0278 + (Math.random() - 0.5) * 0.02, // Randomize coords
            lng: 105.8342 + (Math.random() - 0.5) * 0.02,
            creator: currentUser.name
        };

        DUMMY_KEOS.unshift(newKeo); // Add to the global list
        userCreatedKeos.unshift(newKeo); // Add to user's created list
        
        // Reset and close modal
        keoTitleInput.value = '';
        keoLocationInput.value = '';
        keoMaxInput.value = '5'; // Reset max participants
        titleSuggestionsContainer.innerHTML = '';
        closeModal(createKeoModal);

        // Update UI: Reset filter to 'all' and re-render
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
        renderKeos('all');
        renderKeoDetails(newKeo); // Show details of the newly created keo
    });
    
    // --- Render Profile Keo Lists ---
    function renderProfileKeoList(keos, container) {
        if (keos.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center">${container.id === 'tab-content-created' ? translations[currentLang].profile_no_created : translations[currentLang].profile_no_joined}</p>`;
            return;
        }
        container.innerHTML = keos.map(keo => `
            <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="openKeoFromProfile('${keo.id}')">
                <p class="font-semibold truncate">${keo.title}</p>
                <p class="text-xs text-gray-500">${keo.location} - ${keo.time}</p>
            </div>
        `).join('');
    }
    
    // Function to close profile modal and show keo details
    function openKeoFromProfile(keoId) {
        const keo = DUMMY_KEOS.find(k => k.id === keoId);
        if (keo) {
            closeModal(profileModal);
            renderKeoDetails(keo);
             // Ensure the feed filter is 'all' to see the keo if it doesn't match current filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
            renderKeos('all'); // Re-render feed might be needed if filter was active
        }
    }

    // --- Event Listeners ---
    filtersContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.classList.contains('filter-btn')) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            renderKeos(e.target.dataset.filter);
        }
    });

    // Auth Flow Logic
    function showScreen(screenToShow) {
        [loginScreen, signupScreen, verificationScreen].forEach(screen => {
            if (screen === screenToShow) {
                screen.classList.remove('hidden');
            } else {
                screen.classList.add('hidden');
            }
        });
         if (screenToShow) authContainer.classList.remove('hidden'); else authContainer.classList.add('hidden');
         if (!screenToShow) mainApp.classList.remove('hidden'); else mainApp.classList.add('hidden');
    }

    function showLoginScreen(e) { if(e) e.preventDefault(); showScreen(loginScreen); }
    function showSignupScreen(e) { if(e) e.preventDefault(); showScreen(signupScreen); }

    loginBtn.addEventListener('click', () => showScreen(null)); // Hide auth, show main app
    signupLink.addEventListener('click', showSignupScreen);
    backToLoginLink.addEventListener('click', showLoginScreen);
    signupBtn.addEventListener('click', () => showScreen(verificationScreen)); // Show verification
    submitVerificationBtn.addEventListener('click', () => showScreen(null)); // Hide auth, show main app
    
    logoutBtn.addEventListener('click', () => {
        closeModal(profileModal);
        showScreen(loginScreen); // Hide main app, show login
        termsCheckbox.checked = false;
        loginBtn.disabled = true;
        // Clear user-specific data (optional, depends on real implementation)
        userCreatedKeos = [];
        userJoinedKeos = [];
        // Reset details pane
        keoDetailsContainer.innerHTML = `<div class="text-center text-gray-500 pt-10"><p class="text-lg font-semibold">${translations[currentLang].details_prompt_title}</p><p class="text-sm">${translations[currentLang].details_prompt_subtitle}</p></div>`;
    });

    termsCheckbox.addEventListener('change', () => { loginBtn.disabled = !termsCheckbox.checked; });
    cccdUploadInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            uploadText.textContent = translations[currentLang].upload_status_uploaded;
            uploadText.classList.add('text-teal-600', 'font-bold');
            submitVerificationBtn.disabled = false;
        } else {
             uploadText.textContent = translations[currentLang].verify_front;
             uploadText.classList.remove('text-teal-600', 'font-bold');
             submitVerificationBtn.disabled = true;
        }
    });

    // Language switcher logic
    document.getElementById('lang-vi').addEventListener('click', () => setLanguage('vi'));
    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));

    // Modal Logic
    const openModal = (modal) => modal.classList.remove('hidden');
    const closeModal = (modal) => modal.classList.add('hidden');

    createKeoBtn.addEventListener('click', () => openModal(createKeoModal));
    profileBtn.addEventListener('click', () => {
        // Update profile modal before showing
        profileName.textContent = currentUser.name;
        // profileUniversity.textContent = currentUser.university; // Update if needed
        profileAvatar.src = `https://placehold.co/100x100/A7F3D0/134E4A?text=${currentUser.avatarInitial}`;
        profileAvatarText.src = `https://placehold.co/100x100/A7F3D0/134E4A?text=${currentUser.avatarInitial}`;
        profileHeaderText.textContent = currentUser.name;
        // Render keo lists
        renderProfileKeoList(userCreatedKeos, createdKeosTab);
        renderProfileKeoList(userJoinedKeos, joinedKeosTab);
        // Reset to first tab
        document.querySelectorAll('.profile-tab').forEach(t=>t.classList.remove('active'));
        document.querySelector('.profile-tab[data-tab="created"]').classList.add('active');
        createdKeosTab.classList.remove('hidden');
        joinedKeosTab.classList.add('hidden');

        openModal(profileModal);
    });
    
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modal = e.target.closest('.fixed[id$="-modal"]'); // Find closest modal parent
            if (modal) closeModal(modal);
        });
    });

    document.querySelectorAll('#modals-container > .fixed').forEach(modal => {
        modal.addEventListener('click', (e) => {
            // Close modal if clicking on the background overlay
            if (e.target === modal) closeModal(modal);
        });
    });
    
    // Profile Tabs Logic
    const profileTabs = document.querySelectorAll('.profile-tab');
    const tabContents = { created: createdKeosTab, joined: joinedKeosTab };
    profileTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            profileTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            Object.values(tabContents).forEach(c => c.classList.add('hidden'));
            tabContents[tab.dataset.tab].classList.remove('hidden');
            // Re-render list in case language changed while modal was open
            if(tab.dataset.tab === 'created') renderProfileKeoList(userCreatedKeos, createdKeosTab);
            if(tab.dataset.tab === 'joined') renderProfileKeoList(userJoinedKeos, joinedKeosTab);
        });
    });

    // --- Initial State ---
    loginBtn.disabled = true; // Login button disabled initially
    submitVerificationBtn.disabled = true; // Verification button disabled initially
    setLanguage('vi'); // Set default language
    // Don't call initMap here, it's called by the Google Maps script callback

</script>
<!-- IMPORTANT: Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>
</body>
</html>

